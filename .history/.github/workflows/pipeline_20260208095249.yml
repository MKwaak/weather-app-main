name: Weather App Master Framework

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      run_load_test:
        description: "Voer de k6 Load Test uit?"
        required: true
        type: boolean
        default: false
      run_chaos_test:
        description: "Voer de Chaos Test uit?"
        required: true
        type: boolean
        default: false

jobs:
  # STAP 1: Scannen, Bouwen en Pushen (De "Fabriek")
  scan-build-and-push:
    runs-on: self-hosted
    outputs:
      deploy_ver: ${{ steps.versioning.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Nodig voor SonarCloud historie

      # De Uitsmijter: Eerst scannen!
      - name: üîç SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Alleen als scan slaagt: Versie bepalen
      - name: üè∑Ô∏è Versioning & HTML Inject
        id: versioning
        run: |
          MAJOR=2
          MINOR=1
          PATCH=${{ github.run_number }}
          SEMVER="${MAJOR}.${MINOR}.${PATCH}"
          # Injecteer versie in HTML
          sed -i "s|{{VERSION}}|$SEMVER|g" index.html
          echo "version=$SEMVER" >> $GITHUB_OUTPUT

      # Image bouwen en naar Docker Hub (of jouw registry)
      - name: üê≥ Build & Push Docker Image
        run: |
          VERSION=${{ steps.versioning.outputs.version }}
          docker build -t mkwaak/weather-app-main:$VERSION .
          docker push mkwaak/weather-app-main:$VERSION

  # STAP 2: De Beveiliger (Start zodra de image er is)
  security-scan:
    needs: scan-build-and-push
    runs-on: self-hosted
    steps:
      - name: üõ°Ô∏è Trivy Scan
        run: |
          VERSION=${{ needs.scan-build-and-push.outputs.deploy_ver }}
          trivy image --severity HIGH,CRITICAL --exit-code 0 --format json --output tests/security_results.json mkwaak/weather-app-main:$VERSION

      - name: Upload Security Result
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: tests/security_results.json

  # STAP 3: De Installateur (Start na de build)
  deploy:
    needs: scan-build-and-push
    runs-on: self-hosted
    outputs:
      service_url: ${{ steps.get_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      - name: ‚ò∏Ô∏è K8s Deploy & Patch
        run: |
          VERSION=${{ needs.scan-build-and-push.outputs.deploy_ver }}
          # Patch deployment (sed syntax geoptimaliseerd voor Linux/Mac)
          sed -i "s|mkwaak/weather-app-main:.*|mkwaak/weather-app-main:$VERSION|g" deployment.yaml

          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl rollout status deployment/weather-app-deployment

      - name: üîó Get Dynamic URL
        id: get_url
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            IP="127.0.0.1"
          else
            IP=$(minikube ip)
          fi
          PORT=$(kubectl get svc weather-service -o jsonpath='{.spec.ports[0].nodePort}')
          URL="http://$IP:$PORT"
          echo "url=$URL" >> $GITHUB_OUTPUT
          # Deze regel is essentieel voor je eigen controle in de logs:
          echo "Berekende URL voor $OSTYPE: $URL"

  # BOLLETJE 4: De Test-Batterij (Inclusief Chaos)
  testing:
    needs: deploy
    runs-on: self-hosted
    env:
      TEST_URL: ${{ needs.deploy.outputs.service_url }}
    steps:
      - uses: actions/checkout@v4 # Altijd even checken of je in de juiste map zit

      - name: üîç 1. Functional Tests (Altijd)
        run: |
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin:/usr/local/bin"
          pytest tests/test_entry.py || true

      # HIER IS DE PERFECTE PLEK:
      - name: ‚è≥ Wait for service to be ready
        run: sleep 10

      - name: ‚ö° 2. Performance Tests
        if: github.event_name == 'push' || github.event.inputs.run_load_test == 'true'
        run: |
          export PATH="$PATH:/usr/local/bin"
          k6 run -e TEST_URL=$TEST_URL --summary-export=tests/perf_results.json tests/performance_test.js || true

      - name: üèãÔ∏è 3. Load Tests
        if: github.event.inputs.run_load_test == 'true'
        env:
          TARGET_VERSION: "2.0.${{ github.run_number }}"
          TEST_URL: ${{ env.TEST_URL }}
        run: |
          export PATH="$PATH:/usr/local/bin"
          k6 run -e TARGET_VERSION=$TARGET_VERSION -e TEST_URL=$TEST_URL --summary-export=tests/load_test_results.json tests/load_test.js || true

      - name: üå™Ô∏è 4. Chaos Test
        if: github.event.inputs.run_chaos_test == 'true'
        env:
          TARGET_VERSION: 2.0.${{ github.run_number }}
          TEST_URL: ${{ env.TEST_URL }} # <--- Vergeet deze niet mee te geven
        run: |
          export PATH="$PATH:/usr/local/bin:/usr/bin"
          echo "Start Chaos Test..."
          # Start k6 op de achtergrond
          k6 run -e TARGET_VERSION=$TARGET_VERSION -e TEST_URL=$TEST_URL --summary-export=tests/chaos_results.json tests/load_test.js &

          # VS Code/Git wil dit: onthoud het proces-id
          K6_PID=$!

          # Geef k6 even tijd om warm te draaien (steady state)
          sleep 20

          # De Chaos klap!
          kubectl delete pod -l app=weather-app --now

          # CRUCIAAL: Wacht tot k6 zijn volledige run afmaakt
          wait $K6_PID || true

      # Aan het einde van de 'testing' job:
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always() # Zorg dat dit ALTIJD gebeurt, ook als een test faalt!
        with:
          name: k6-reports
          path: tests/*.json

  # BOLLETJE 5: De Judge (Het Eindstation)
  quality-gate:
    needs: [security-scan, testing]
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4 # Haal de scripts op

      - name: Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: tests/

      - name: Download k6 Reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports
          path: tests/

      - name: üèÜ Final Quality Assessment
        run: |
          # Nu pas staan de JSON's klaar voor de Python script!
          python3 tests/calculate_score.py
