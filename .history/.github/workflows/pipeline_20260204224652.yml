name: Weather App Master Framework

on:
  push:
    branches: [master]

jobs:
  # BOLLETJE 1: De Bouwer
  build-and-push:
    runs-on: self-hosted
    outputs:
      deploy_ver: ${{ steps.versioning.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Versioning & HTML Inject
        id: versioning
        run: |
          VERSION="2.0.${{ github.run_number }}"
          # Injecteer versie in HTML
          sed -i '' "s|{{VERSION}}|$VERSION|g" index.html
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push Image
        run: |
          docker build -t mkwaak/weather-app-main:${{ steps.versioning.outputs.version }} .
          docker push mkwaak/weather-app-main:${{ steps.versioning.outputs.version }}

  # BOLLETJE 2: De Beveiliger (Parallel aan Deploy!)
  security-scan:
    needs: build-and-push
    runs-on: self-hosted
    steps:
      - name: üõ°Ô∏è Trivy Scan
        run: |
          trivy image --severity HIGH,CRITICAL --exit-code 0 --format json --output tests/security_results.json mkwaak/weather-app-main:${{ needs.build-and-push.outputs.deploy_ver }}

  # BOLLETJE 3: De Installateur
  deploy:
    needs: build-and-push
    runs-on: self-hosted
    outputs:
      service_url: ${{ steps.get_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      - name: K8s Deploy & Patch
        run: |
          VERSION=${{ needs.build-and-push.outputs.deploy_ver }}
          # Patch de deployment file met de nieuwe image versie
          sed -i '' "s|mkwaak/weather-app-main:v2|mkwaak/weather-app-main:$VERSION|g" deployment.yaml

          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl rollout status deployment/weather-app-deployment

      - name: üîó Get Dynamic URL
        id: get_url
        run: |
          URL=$(minikube service weather-service --url | head -n 1)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Dynamisch adres gevonden: $URL"

  # BOLLETJE 4: De Test-Batterij (Inclusief Chaos)
  testing:
    needs: deploy
    runs-on: self-hosted
    env:
      TEST_URL: ${{ needs.deploy.outputs.service_url }}
    steps:
      - name: üöÄ Run All Tests
        run: |
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin"

          # 1. Functional
          pytest tests/test_entry.py || true

          # 2. Performance
          k6 run -e MY_URL=$TEST_URL --summary-export=tests/perf_$(date +%s).json tests/performance_test.js || true

          # 3. Load
          k6 run -e MY_URL=$TEST_URL --summary-export=tests/load_$(date +%s).json tests/load_test.js || true

          # 4. Chaos (Achtergrond load + pod delete)
          echo "Start Chaos Test..."
          k6 run -e MY_URL=$TEST_URL --summary-export=tests/chaos_$(date +%s).json tests/load_test.js &
          K6_PID=$!
          sleep 10
          kubectl delete pod -l app=weather-app --now
          wait $K6_PID || true

  # BOLLETJE 5: De Judge (Het Eindstation)
  quality-gate:
    needs: [security-scan, testing] # Wacht op BEIDE jobs
    runs-on: self-hosted
    steps:
      - name: üèÜ Calculate Quality Score
        run: |
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin"
          python3 tests/calculate_score.py
