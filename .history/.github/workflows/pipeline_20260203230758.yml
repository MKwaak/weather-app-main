name: Weather App CI/CD

on:
  push:
    branches: [master] # De actie start zodra je naar master pusht

jobs:
  build-and-test:
    runs-on: self-hosted # Dit vertelt GitHub: "Gebruik Marcel's Mac"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inject Version and Prepare
        run: |
          # 1. Bepaal de versie
          VERSION="2.0.${{ github.run_number }}"
          echo "DEPLOY_VER=$VERSION" >> $GITHUB_ENV

          # 2. Injecteer in HTML VOORDAT we Docker bouwen
          sed -i '' "s|{{VERSION}}|$VERSION|g" index.html

          # 3. Patch de deployment.yaml vast voor K8s (we vervangen v2 door de nieuwe versie)
          sed -i '' "s|mkwaak/weather-app-main:v2|mkwaak/weather-app-main:$VERSION|g" deployment.yaml

      - name: Build and Push Image
        run: |
          # We gebruiken de variabele die we net hebben opgeslagen
          docker build -t mkwaak/weather-app-main:${{ env.DEPLOY_VER }} .
          docker push mkwaak/weather-app-main:${{ env.DEPLOY_VER }}

      - name: Deploy to Minikube
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl rollout status deployment/weather-app-deployment

      - name: Deploy to Minikube
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl rollout status deployment/weather-app-deployment

      - name: Run Functional Entry Test
        run: |
          # We vertellen de runner waar de tools staan (voor de zekerheid)
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin"
          pytest tests/test_entry.py

      - name: Run Performance Load Test
        run: |
          # k6 draait de test en checkt de thresholds (P95 < 200ms)
          k6 run tests/load_test.js
