name: Weather App Master Framework

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      override_reason:
        description: "Reden voor handmatige goedkeuring (Stakeholder Override)"
        required: false
        default: ""
      run_load_test:
        description: "Voer de k6 Load Test uit?"
        required: true
        type: boolean
        default: false
      run_chaos_test:
        description: "Voer de Chaos Test uit?"
        required: true
        type: boolean
        default: false

jobs:
  # STAP 1: Scannen, Bouwen en Pushen (De "Fabriek")
  scan-build-and-push:
    runs-on: self-hosted
    outputs:
      deploy_ver: ${{ steps.versioning.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Nodig voor SonarCloud historie

      - name: üîç Debug Sonar Config
        run: |
          ls -la sonar-project.properties
          cat sonar-project.properties
          pwd

      # De Uitsmijter: Eerst scannen! (Nieuwste versie)
      - name: üîç SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Alleen als scan slaagt: Versie bepalen
      - name: üè∑Ô∏è Versioning & HTML Inject
        id: versioning
        run: |
          # 1. Pad naar het bestand op je Mac (self-hosted runner pad)
          VERSION_FILE="VERSION"

          # 2. Lees huidige versie of start bij basis
          CURRENT_VERSION=$(cat $VERSION_FILE 2>/dev/null || echo "2.1.94")

          # 3. Splitsen
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # 4. Check commit message voor #minor
          # Gebruik de github context om de message te scannen
          COMMIT_MSG=$(git log -1 --pretty=%B)

          if [[ "$COMMIT_MSG" == *"#minor"* ]]; then
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "‚ú® Minor update gedetecteerd"
          else
            PATCH=$((PATCH + 1))
            echo "üêû Patch update gedetecteerd"
          fi

          SEMVER="${MAJOR}.${MINOR}.${PATCH}"
          echo "NEW_VERSION=$SEMVER"

          # 5. Opslaan voor de VOLGENDE run (lokaal op je Mac)
          echo "$SEMVER" > $VERSION_FILE

          # 6. Injecteren in de huidige build
          sed -i.bak "s/{{VERSION}}/${SEMVER}/g" index.html && rm index.html.bak

          # 7. Omgevingsvariabelen voor de rest van de pipeline
          echo "APP_VERSION=$SEMVER" >> $GITHUB_ENV
          echo "version=$SEMVER" >> $GITHUB_OUTPUT

      # Image bouwen en naar Docker Hub (of jouw registry)
      - name: üê≥ Build & Push Docker Image
        run: |
          VERSION=${{ steps.versioning.outputs.version }}
          docker build -t mkwaak/weather-app-main:$VERSION .
          docker push mkwaak/weather-app-main:$VERSION

  # STAP 2: De Beveiliger (Start zodra de image er is)
  security-scan:
    needs: scan-build-and-push
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: üõ°Ô∏è Trivy Scan
        run: |
          VERSION=${{ needs.scan-build-and-push.outputs.deploy_ver }}
          mkdir -p tests
          trivy image --severity HIGH,CRITICAL --exit-code 0 --format json --output tests/security_results.json mkwaak/weather-app-main:$VERSION

      - name: Upload Security Result
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: tests/security_results.json # Upload alleen de specifieke file

  # STAP 3: De Installateur (Start na de build)
  deploy:
    needs: scan-build-and-push
    runs-on: self-hosted
    outputs:
      service_url: ${{ steps.get_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: ‚ò∏Ô∏è K8s Deploy & Update
        run: |
          VERSION=${{ needs.scan-build-and-push.outputs.deploy_ver }}
          echo "Deploying version: $VERSION"

          # 1. Pas de file aan voor de administratie (optioneel)
          sed -i '' "s|mkwaak/weather-app-main:.*|mkwaak/weather-app-main:$VERSION|g" deployment.yaml

          # 2. Forceer de update direct in het cluster (deze is leidend!)
          kubectl apply -f deployment.yaml
          kubectl set image deployment/weather-app-deployment $(kubectl get deployment weather-app-deployment -o jsonpath='{.spec.template.spec.containers[0].name}')=mkwaak/weather-app-main:$VERSION

          # 3. Wachten tot het live staat
          kubectl rollout status deployment/weather-app-deployment

      - name: üîó Get Dynamic URL
        id: get_url
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            IP="127.0.0.1"
          else
            IP=$(minikube ip)
          fi
          PORT=$(kubectl get svc weather-service -o jsonpath='{.spec.ports[0].nodePort}')
          URL="http://$IP:$PORT"
          echo "url=$URL" >> $GITHUB_OUTPUT
          # Deze regel is essentieel voor je eigen controle in de logs:
          echo "Berekende URL voor $OSTYPE: $URL"

  # BOLLETJE 4: De Test-Batterij (Inclusief Chaos)
  testing:
    needs: [deploy, security-scan]
    runs-on: self-hosted
    env:
      # CENTRALE PLEK VOOR DE POORT
      APP_PORT: "57974" # Hardocoded voor de curl checks, we gebruiken de URL variabele voor k6
      TEST_URL: "http://localhost:57974" # We gebruiken hier nog even de volledige URL voor k6
    steps:
      - uses: actions/checkout@v4

      - name: üìÇ Prepare Test Directory
        run: mkdir -p tests

      - name: üì• Download Security Results
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: tests/

      - name: üö™ Entry Check
        run: |
          # Gebruik de variabele $APP_PORT in de curl en de logging
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${{ env.APP_PORT }}/health || echo "000")

          if [ "$STATUS" == "200" ]; then
            echo "{\"score\": 100, \"detail\": \"App up on port ${{ env.APP_PORT }}\"}" > tests/entry_results.json
          else
            echo "{\"score\": 0, \"detail\": \"App unreachable on port ${{ env.APP_PORT }}\"}" > tests/entry_results.json
          fi

      - name: üîç 1. Functional Entry Check
        run: |
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin:/usr/local/bin"
          pytest tests/test_entry.py || true

      - name: üåç 2. Location Accuracy Check
        run: |
          python3 tests/location_test.py --url $TEST_URL --output tests/accuracy_results.json

      - name: ‚è≥ Wait for service steady-state
        run: sleep 5

      - name: ‚ö° 3. Performance Benchmark
        if: github.event_name == 'push' || github.event.inputs.run_load_test == 'true'
        run: |
          export PATH="$PATH:/usr/local/bin"
          k6 run -e TEST_URL=$TEST_URL --summary-export=tests/perf_results.json tests/performance_test.js || true

      - name: üèãÔ∏è 4. Load Tests
        if: github.event.inputs.run_load_test == 'true'
        run: |
          export PATH="$PATH:/usr/local/bin"
          k6 run -e TEST_URL=$TEST_URL --summary-export=tests/load_results.json tests/load_test.js || true

      - name: üå™Ô∏è 5. Chaos Test (Resilience)
        if: github.event.inputs.run_chaos_test == 'true'
        run: |
          export PATH="$PATH:/usr/local/bin:/usr/bin"
          echo "Start Chaos Test..."
          k6 run -e TEST_URL=$TEST_URL --summary-export=tests/chaos_results.json tests/load_test.js &
          K6_PID=$!
          sleep 20
          kubectl delete pod -l app=weather-app --now
          wait $K6_PID || true

      - name: üì§ Upload All Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-reports
          path: tests/*.json # Nu pakken we alles in √©√©n keer uit de tests/ map

  # BOLLETJE 5: De Judge (Het Eindstation)
  quality-gate:
    needs: [scan-build-and-push, security-scan, testing] # Zorg dat hij op alles wacht
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: . # We downloaden alles naar de root voor het gemak

      - name: Download k6 Reports
        uses: actions/download-artifact@v4
        with:
          name: k6-reports
          path: .

      - name: üèÜ Final Quality Assessment
        env:
          APP_VERSION: ${{ needs.scan-build-and-push.outputs.deploy_ver }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # Koppeling van de input naar de Judge:
          OVERRIDE_REASON: ${{ github.event.inputs.override_reason }}
          APP_PORT: ${{ env.APP_PORT }}
        run: |
          python3 tests/calculate_score.py
