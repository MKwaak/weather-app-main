name: Weather App Refinery Framework (v2.0)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      override_reason:
        description: "Reden voor handmatige goedkeuring"
        required: false
        default: ""

env:
  APP_PORT: "57974"
  TEST_URL: "http://localhost:57974"

jobs:
  # --- STAGE 0: REFINERY INTAKE (Versioning) ---
  versioning:
    runs-on: ubuntu-latest
    # Voeg dit blok toe:
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üî¢ Calculate Next Version
        id: bump
        run: |
          # Haal laatste tag op of start bij 1.0.0
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1 | sed 's/v//')
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="1.0.0"; fi

          IFS='.' read -r major minor patch <<< "$LATEST_TAG"
          COMMIT_MSG=$(git log -1 --pretty=%B)

          if [[ "$COMMIT_MSG" == *"#major"* ]]; then
            NEW_VER="$((major + 1)).0.0"
          elif [[ "$COMMIT_MSG" == *"#minor"* ]]; then
            NEW_VER="${major}.$((minor + 1)).0"
          else
            NEW_VER="${major}.${minor}.$((patch + 1))"
          fi

          echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT
          echo "üöÄ Refinery Versioning: $NEW_VER"

      - name: üè∑Ô∏è Create Tag
        run: |
          git config user.name "Refinery Bot"
          git config user.email "refinery@qa.internal"
          git tag v${{ steps.bump.outputs.new_version }}
          git push origin v${{ steps.bump.outputs.new_version }}

  # --- STAGE 1: CI (Universele Test Machine) ---
  unit-tests:
    needs: versioning
    runs-on: ubuntu-latest
    container:
      image: node:20-bullseye
    steps:
      - uses: actions/checkout@v4
      - name: ‚öôÔ∏è Read Refinery Config
        id: config
        run: |
          TEST_CMD=$(node -p "require('./refinery-config.json').testCommand")
          COV_PATH=$(node -p "require('./refinery-config.json').coveragePath")
          echo "TEST_EXEC_CMD=$TEST_CMD" >> $GITHUB_ENV
          echo "COVERAGE_RESULT_PATH=$COV_PATH" >> $GITHUB_ENV
      - name: üì¶ Install & Test
        run: |
          npm install
          ${{ env.TEST_EXEC_CMD }}
      - name: üì§ Export Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          # DIT IS HET BELANGRIJKSTE:
          # Jest schrijft ALTIJD naar 'coverage/' tenzij anders ingesteld.
          path: coverage/lcov.info

  # --- STAGE 2: QUALITY & BUILD (The Refinery Engine) ---
  scan-build-and-push:
    needs: [versioning, unit-tests]
    runs-on: self-hosted
    outputs:
      deploy_ver: ${{ needs.versioning.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Refinery Context
        id: context
        run: |
          SONAR_KEY=$(node -p "require('./refinery-config.json').sonarProjectKey")
          echo "SONAR_KEY=$SONAR_KEY" >> $GITHUB_ENV
          VERSION=${{ needs.versioning.outputs.new_version }}
          sed -i.bak "s/{{VERSION}}/${VERSION}/g" index.html && rm index.html.bak

      - name: üì• Download Coverage for Sonar
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/ # Sonar zoekt vaak in de map 'coverage'

      - name: üõ†Ô∏è Fix Paden voor Sonar (Mac specific)
        run: |
          # We strippen ALLES weg tot en met de laatste slash voor de bestandsnaam
          # zodat SF:/Users/marcel/.../weather-app-main/app.js verandert in SF:app.js
          sed -i.bak 's|SF:.*/weather-app-main/|SF:|g' coverage/lcov.info

          echo "--- DEBUG: Check of paden nu relatief zijn ---"
          grep "SF:" coverage/lcov.info | head -n 3

      - name: üîç SonarCloud Scan (V5.0.0 - State of the Art)
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ env.SONAR_KEY }}
            -Dsonar.organization=mkwaak
            -Dsonar.projectVersion=${{ needs.versioning.outputs.new_version }}
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=tests/**,**/node_modules/**

      - name: üê≥ Build & Push Docker Image
        run: |
          VERSION=${{ needs.versioning.outputs.new_version }}
          docker build --build-arg APP_VERSION=$VERSION -t mkwaak/weather-app-main:$VERSION .
          docker push mkwaak/weather-app-main:$VERSION

  # --- STAGE 3: SECURITY, DEPLOY & TEST LAB ---
  security-scan:
    needs: scan-build-and-push
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: üõ°Ô∏è Trivy Scan
        run: |
          mkdir -p tests
          trivy image --severity HIGH,CRITICAL --format json --output tests/security_results.json mkwaak/weather-app-main:${{ needs.scan-build-and-push.outputs.deploy_ver }}
      - name: üì§ Upload Security Result
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: tests/security_results.json

  deploy:
    needs: scan-build-and-push
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: ‚ò∏Ô∏è K8s Deploy
        run: |
          VERSION=${{ needs.scan-build-and-push.outputs.deploy_ver }}
          sed -i.bak "s|mkwaak/weather-app-main:.*|mkwaak/weather-app-main:$VERSION|g" deployment.yaml
          kubectl apply -f deployment.yaml
          kubectl rollout status deployment/weather-app-deployment

  # --- STAGE 4: EVALUATION (Entry, Perf & Functional) ---
  entry-and-functional:
    needs: deploy
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: üö™ Entry Check & Functional
        run: |
          mkdir -p tests
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$APP_PORT/ || echo "000")
          echo "{\"score\": $( [ "$STATUS" == "200" ] && echo 100 || echo 0 ), \"detail\": \"Status: $STATUS\"}" > tests/entry_results.json
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin:/usr/local/bin"
          python3 tests/location_test.py --url $TEST_URL --output tests/accuracy_results.json
      - name: üì§ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: entry-results
          path: tests/*.json

  performance-benchmark:
    needs: entry-and-functional
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: ‚ö° k6 Benchmark
        run: |
          mkdir -p tests
          k6 run -e TEST_URL=$TEST_URL --summary-export=tests/perf_results.json tests/performance_test.js || true
      - name: üì§ Upload Perf
        uses: actions/upload-artifact@v4
        with:
          name: perf-report
          path: tests/perf_results.json

  # --- STAGE 5: THE JUDGE ---
  quality-gate:
    needs:
      [
        unit-tests,
        versioning,
        scan-build-and-push,
        security-scan,
        entry-and-functional,
        performance-benchmark,
      ]

    if: always()
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: üì• Collect All Refinery Data
        uses: actions/download-artifact@v4
        with:
          # We downloaden alles in √©√©n keer.
          # GitHub pakt alle artifacts van deze run en legt de bestanden in tests/
          path: tests/
          merge-multiple: true

      - name: ‚è≥ Wait for SonarCloud Processing
        # We geven SonarCloud 20 seconden om de Task ID te verwerken
        run: sleep 20

      - name: üèÜ Final Quality Assessment
        env:
          APP_VERSION: ${{ needs.versioning.outputs.new_version }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # We geven de Sonar Key ook mee aan de Judge voor de zekerheid
          SONAR_PROJECT_KEY: "MKwaak_weather-app-main"
        run: python3 tests/calculate_score.py
