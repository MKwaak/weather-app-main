name: Weather App CI/CD

on:
  push:
    branches: [master] # De actie start zodra je naar master pusht

jobs:
  build-and-test:
    runs-on: self-hosted # Dit vertelt GitHub: "Gebruik Marcel's Mac"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inject Version and Prepare
        run: |
          # 1. Bepaal de versie
          VERSION="2.0.${{ github.run_number }}"
          echo "DEPLOY_VER=$VERSION" >> $GITHUB_ENV

          # 2. Injecteer in HTML VOORDAT we Docker bouwen
          sed -i '' "s|{{VERSION}}|$VERSION|g" index.html

          # 3. Patch de deployment.yaml vast voor K8s (we vervangen v2 door de nieuwe versie)
          sed -i '' "s|mkwaak/weather-app-main:v2|mkwaak/weather-app-main:$VERSION|g" deployment.yaml

      - name: Build and Push Image
        run: |
          # We gebruiken de variabele die we net hebben opgeslagen
          docker build -t mkwaak/weather-app-main:${{ env.DEPLOY_VER }} .
          docker push mkwaak/weather-app-main:${{ env.DEPLOY_VER }}

      - name: Deploy to Minikube
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl rollout status deployment/weather-app-deployment

      - name: üöÄ Run Functional Entry Test
        run: |
          export PATH="$PATH:/Users/marcelkwakernaak/Library/Python/3.9/bin"
          pytest tests/test_entry.py

      - name: ‚è±Ô∏è Run Performance Test
        run: |
          # Snelle check: 1 gebruiker, kijken naar de baseline timestamps
          k6 run --vus 1 --duration 10s tests/performance_test.js

      - name: üìà Run Load Test
        run: |
          # Zware check: Ramping up naar 20+ gebruikers
          k6 run tests/load_test.js

      - name: üí• Run Chaos Recovery Test
        run: |
          echo "Start de load voor de chaos test..."
          # Start k6 in de achtergrond (&)
          k6 run tests/load_test.js &
          K6_PID=$!

          echo "Wacht tot de druk oploopt..."
          sleep 15

          echo "CHAOS: Een pod verwijderen terwijl de test draait..."
          kubectl delete pod -l app=weather-app --now

          echo "Controleren of Kubernetes een nieuwe pod start..."
          kubectl get pods

          # Wacht tot k6 klaar is en vang de exit code op
          wait $K6_PID
